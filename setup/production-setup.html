<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Production Setup - Matrix Cerberus Documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../setup.html"><strong aria-hidden="true">2.</strong> Installation and Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../setup/development-setup.html"><strong aria-hidden="true">2.1.</strong> Development Setup</a></li><li class="chapter-item expanded "><a href="../setup/production-setup.html" class="active"><strong aria-hidden="true">2.2.</strong> Production Setup</a></li><li class="chapter-item expanded "><a href="../setup/testing.html"><strong aria-hidden="true">2.3.</strong> Testing</a></li></ol></li><li class="chapter-item expanded "><a href="../usage.html"><strong aria-hidden="true">3.</strong> Usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../usage/login.html"><strong aria-hidden="true">3.1.</strong> Login</a></li><li class="chapter-item expanded "><a href="../usage/accounts.html"><strong aria-hidden="true">3.2.</strong> Accounts</a></li><li class="chapter-item expanded "><a href="../usage/room_settings.html"><strong aria-hidden="true">3.3.</strong> Room Settings</a></li><li class="chapter-item expanded "><a href="../usage/rooms.html"><strong aria-hidden="true">3.4.</strong> Rooms</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Matrix Cerberus Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/MatrixDoctors/matrix-cerberus" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="production-setup"><a class="header" href="#production-setup">Production Setup</a></h1>
<h2 id="requirements"><a class="header" href="#requirements">Requirements</a></h2>
<ul>
<li>Access to a local machine or development server as a non-root user with sudo privileges</li>
<li>Docker is installed, signed in and running.
<ul>
<li>Installation link: https://docs.docker.com/engine/install/</li>
</ul>
</li>
<li>Docker compose is installed
<ul>
<li>Installation link: https://docs.docker.com/compose/install/</li>
</ul>
</li>
<li>Node.js and npm installed
<ul>
<li>Use <a href="https://github.com/nvm-sh/nvm">nvm</a> to install and manage multiple versions easily.</li>
</ul>
</li>
</ul>
<h2 id="configuration-files"><a class="header" href="#configuration-files">Configuration files</a></h2>
<p>First comes the configuration files.
This contains all of your sensitive data (i.e third party app IDs and secrets), custom configuration, domain address and other essesntial details which will be required to get your app running properly.</p>
<p>List of configuration and environment files for production:</p>
<ul>
<li><code>config.yml</code> for backend</li>
<li><code>.env.production</code> for frontend</li>
<li><code>nginx.conf</code> in <code>nginx/prod</code> for nginx</li>
</ul>
<h3 id="1-backend-configuration-configyml"><a class="header" href="#1-backend-configuration-configyml">1) Backend configuration (config.yml)</a></h3>
<p>You can follow the same instructions mentioned in <a href="./development-setup.html#1-backend-configuration-configyml">here</a></p>
<h3 id="2-frontend-configuration-envproduction"><a class="header" href="#2-frontend-configuration-envproduction">2) Frontend configuration (.env.production)</a></h3>
<p>Copy the <code>.env.test</code> to a new file <code>.env.production</code>.</p>
<p>Edit the <code>REACT_APP_BASE_URL</code> to the domain url that you intend to host the application on.</p>
<p>You can also optionally edit the <code>REACT_APP_DEFAULT_HOMESERVER</code> to view this homeserver by default when the login page loads for the first time.</p>
<h3 id="3-nginx-configuration-nginxconf"><a class="header" href="#3-nginx-configuration-nginxconf">3) Nginx configuration (nginx.conf)</a></h3>
<p>Copy the <code>nginx.sample.conf</code> to a new file <code>nginx.conf</code> under the same directory (<code>nginx/prod</code>).</p>
<p>Edit the <code>DOMAIN_URL</code> to the domain url that you intend to host the application on.</p>
<h2 id="how-to-issue-ssl-certificates-for-your-domain"><a class="header" href="#how-to-issue-ssl-certificates-for-your-domain">How to issue SSL certificates for your domain?</a></h2>
<p>It is very important to make sure that the application supports HTTPS requests to protect the website and its users from other external factors.</p>
<p>In the docker compose <a href="../docker-compose.yml">file</a>, we've mapped the the local files in certbot directory with other directories which belong to the nginx docker container.</p>
<p>This is to ensure that we keep using the same SSL certificates that has been generated the first time this app has been setup and also to share the data between two different containers i.e. nginx and certbot.</p>
<pre><code>  nginx:
    image: &quot;nginx:latest&quot;
    volumes:
      - ./nginx/prod/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/prod/corsheaders.conf:/etc/nginx/conf.d/corsheaders.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot/:ro
      - ./frontend/build:/usr/src/app
</code></pre>
<pre><code>certbot:
    image: certbot/certbot:latest
    volumes:
      - ./certbot/conf:/etc/letsencrypt:rw
      - ./certbot/www/:/var/www/certbot/:rw
</code></pre>
<p>Run the following command to fill the <code>certbot</code> directory with certificates.</p>
<pre><code class="language-bash">docker-compose run --rm  certbot certonly --webroot --webroot-path /var/www/certbot/ -d {DOMAIN_URL}
</code></pre>
<p><strong>Note:</strong>
There is a limit to how many certificates can be generated per registered domain. (It is 50 per week)
Please check out <a href="https://letsencrypt.org/docs/rate-limits/">https://letsencrypt.org/docs/rate-limits/</a></p>
<p>The generated certificates are only valid for 3 months. To renew the certificates run the command</p>
<pre><code>docker-compose run --rm certbot renew
</code></pre>
<p>If you run into any issues while setting up https and certbot, do check out this <a href="https://mindsers.blog/post/https-using-nginx-certbot-docker/">article</a> or join <a href="https://matrix.to/#/#matrix-cerberus:cadair.com">#matrix-cerberus:cadair.dev</a> so that we can work out a solution together!</p>
<h2 id="build-the-react-frontend"><a class="header" href="#build-the-react-frontend">Build the React frontend</a></h2>
<p>To use the frontend code in production, we'll have to use the optimized build produced by the <code>react-scripts</code> from create-react-app.</p>
<p>But we first need to install the packages before we start building the code.</p>
<pre><code>cd frontend/
npm install
</code></pre>
<p>After the packages have been installed, we can simply run</p>
<pre><code>npm run build
</code></pre>
<p>and we will find a new <code>build/</code> directory created.</p>
<p>This will later be served by <a href="https://www.nginx.com/resources/wiki/">Nginx</a> to the clients requesting it.</p>
<h2 id="time-to-run-the-application"><a class="header" href="#time-to-run-the-application">Time to run the application!</a></h2>
<p>Now, that you have everything setup, you can simply start the application by running the commands</p>
<pre><code>docker-compose build
docker-compose up
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../setup/development-setup.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../setup/testing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../setup/development-setup.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../setup/testing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
